Elograf

Ce programme est un utilitaire permettant de lancer et de configurer nerd-dictation pour la reconnaissance vocale.

Utilisation

Ce programme est prévu pour être lancé au démarrage de l'environnement de bureau pour afficher une icône dans la barre d'icônes. Utilisez votre gestionnaire de paramètres de bureau préféré pour ajouter le lancement de la commande 'elograf' au démarrage.

L'icône elograf donne accès à un menu avec une entrée pour activer nerd-dictation, une autre pour l'arrêter, une entrée de configuration et une commande pour quitter. L'icône change d'apparence lorsque nerd-dictation est actif.

La configuration comporte une option de clic direct. Quand elle est activée, et après un redémarrage de l'application, un clic sur l'icône lance la dictée. Un nouvel appui sur l'icône arrête nerd-dictation.

Le dialogue de configuration contient une liste sous forme de tableau de tous les modèles de langue qui sont installés sur le système et qui peuvent être sélectionnés. Celui qui est sélectionné sera utilisé.

Les modèles de langue peuvent être téléchargés directement depuis le site web d'alphacei et stockés soit dans l'espace utilisateur, soit dans l'espace système. Pour le stockage dans l'espace système, les informations d'identification root sont demandées par le mécanisme polkit.

Vous pouvez également sélectionner un répertoire où réside un modèle de langue. Vous devez lui donner un nom unique.

Le dialogue de configuration s'affiche si aucun modèle n'a été défini précédemment.

Dans le dialogue Avancé, vous pouvez définir une précommande optionnelle qui est lancée avant nerd-dictation lui-même. Une autre ligne est pour la post-commande optionnelle qui est lancée après l'arrêt de nerd-dictation. Cette option a été prévue notamment pour lancer la commande "setxkbmap fr" pour fiabiliser le fonctionner de XDOTOOL qui simule le clavier.

Vous pouvez également sélectionner ou définir certaines options qui sont passées à nerd-dictation.

Vous pouvez notamment définir l'outil utilisé pour simuler le clavier. XDOTOOL est utilisé par défaut, mais pour l'environnement Wayland, il faut sélectionner DOTOOL. Pour ce dernier, il faut préciser le code à deux lettres de l'agencement du clavier, par exemple 'fr', sinon la disposition 'us' est utilisée.

Raccourcis clavier globaux (KDE uniquement):
Si vous avez PyQt6-DBus installé et que vous utilisez KDE, vous pouvez configurer des raccourcis clavier globaux dans la boîte de dialogue Paramètres avancés. Ces raccourcis fonctionneront à l'échelle du système même lorsque Elograf s'exécute en arrière-plan.

Le démarrage peut prendre un certain temps, en fonction de la taille du modèle.

Interface en ligne de commande

Elograf prend en charge le mode instance unique avec communication inter-processus. Cela vous permet de contrôler une instance en cours d'exécution depuis la ligne de commande.

Options:
    -l, --log <niveau>  : écrit des informations en fonction du niveau. Le niveau est choisi parmi ceux qui sont prévu dans le langage Python
    --begin             : démarre la dictée dans l'instance en cours d'exécution (ou lance si elle n'est pas en cours d'exécution)
    --end               : arrête la dictée dans l'instance en cours d'exécution
    --exit              : quitte l'instance en cours d'exécution

Exemples:
    elograf             : Lance l'application (icône de la barre d'état système, se détache de la console)
    elograf --begin     : Démarre la dictée dans l'instance en cours d'exécution
    elograf --end       : Arrête la dictée dans l'instance en cours d'exécution
    elograf --exit      : Quitte l'application en cours d'exécution

Remarque: Une seule instance d'Elograf peut s'exécuter à la fois. Les commandes sont envoyées à l'instance en cours d'exécution via IPC (D-Bus sous Linux/KDE, ou sockets locaux sur d'autres plateformes). L'application se détache automatiquement de la console au démarrage.

Gestion du démon:

Elograf s'exécute en tant que démon en arrière-plan et peut être géré à l'aide des signaux Unix standard:
    kill $(cat ~/.config/Elograf/elograf.pid)     : Envoie SIGTERM pour un arrêt gracieux
    kill -HUP $(cat ~/.config/Elograf/elograf.pid) : Envoie SIGHUP pour recharger

Le démon gère les signaux suivants de manière gracieuse:
- SIGTERM: Arrête la dictée, nettoie les ressources et quitte
- SIGINT (Ctrl+C): Identique à SIGTERM
- SIGHUP: Arrêt gracieux

Emplacement du fichier PID: ~/.config/Elograf/elograf.pid


Installation

Méthode 1: Utiliser uv (Recommandé)

uv est un gestionnaire de paquets et de projets Python rapide. C'est la méthode d'installation recommandée car elle gère les dépendances automatiquement.

Installer en tant qu'outil (disponible globalement):
    uv tool install git+https://github.com/papoteur-mga/elograf

Pour une installation de développement depuis un répertoire local:
    uv pip install .

Remarque:
- nerd-dictation n'est pas inclus et doit être installé séparément
- PyQt6 inclut le support D-Bus par défaut, activant les raccourcis clavier globaux sur KDE

Méthode 2: Utiliser pip

Dans la ligne de commande en tant que root ou en utilisateur selon la destination souhaitée de l'installation:
    pip install .

Dans ce cas d'une installation dans l'espace utilisateur, assurez vous que ~/.local/bin est bien dans votre variable PATH.
nerd-dictation n'est pas inclus et doit être installé séparément.

Modules Python pré-requis:
- ujson
- urllib
- PyQt6 (inclut le support D-Bus pour les raccourcis globaux sur KDE)

Aspects techniques

Cet outil est écrit en Python 3 et utilise Qt6.

Emplacements des fichiers:
- Fichier de configuration: ~/.config/Elograf/Elograf.conf
- Fichier PID (démon): ~/.config/Elograf/elograf.pid
- Modèles utilisateur: ~/.config/vosk-models
- Modèles système: /usr/share/vosk-models
- Traductions: /usr/share/elograf/translations

Communication inter-processus:
Elograf utilise un système IPC (Inter-Process Communication) adaptatif:
- Sous Linux avec D-Bus disponible: Utilise D-Bus pour la communication et KGlobalAccel pour les raccourcis globaux
- Sur d'autres plateformes ou sans D-Bus: Utilise Qt Local Sockets (QLocalServer/QLocalSocket)
Les deux implémentations prennent en charge la détection d'instance unique et les commandes CLI (--begin, --end, --exit)

Comportement du démon:
- Se détache automatiquement en arrière-plan sur les systèmes Unix (se détache de la console)
- Écrit le PID dans ~/.config/Elograf/elograf.pid
- Gère les signaux (SIGTERM, SIGINT, SIGHUP) pour un arrêt gracieux
- Nettoie les ressources (dictée, IPC, fichier PID) à la sortie
